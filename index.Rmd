---
title: "Debunking Long-Only Commodity Investing"
author: "Dr Mauritz van den Worm, PhD"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  revealjs::revealjs_presentation:
    reveal_options:
      minScale: 1.0
      maxScale: 1.0
      slideNumber: true
    includes:
      in_header: addlogo.html
    theme: simple
    highlight: pygments
    center: true
    mathjax: "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"
    self_contained: false
    reveal_plugins: ["menu"]
    css: custom.css
---


```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

library(ggplot2)
library(plotly)
library(data.table)
library(readr)
library(scales)
library(kableExtra)
library(PortfolioAnalytics)
library(htmlwidgets)


```


# BCOM Index {data-background="img/background_mtns_1.png"}

## BCOM Evolution {data-background="img/BlueBackgroundWithOrange.png"}

```{r}

bcomData <- as.data.table(read_csv("C:/Box/Polar Star - Company Folder/1. Polar Star/Analysis/Analysis and Research/code/debunking-long-only-commodity-investing/data/bcomData.csv"))

setnames(bcomData, "px_last", "BCOM")

pic <- ggplot(bcomData, aes(x=date, y=BCOM)) +
  geom_line() +
  xlab("") +
  scale_x_date(breaks = pretty_breaks(n=15)) +
  scale_y_continuous(breaks = pretty_breaks(n=10)) +
  geom_hline(yintercept = bcomData[date == max(date), BCOM], color = "firebrick") +
  theme(
    plot.background = element_rect(fill = rgb(242,242,242, maxColorValue = 255)),
    panel.background = element_rect(fill = "white"),
    panel.grid.major.y = element_line(size = 0.5, linetype = 'solid',colour = "gray"),
    panel.grid.major.x = element_line(size = 0.5, linetype = 'dashed',colour = "gray"),
    axis.title.x = element_text(colour = rgb(5,61,96, maxColorValue = 255), size = 16),
    axis.title.y = element_text(colour = rgb(5,61,96, maxColorValue = 255), size = 16),
    plot.title = element_text(colour = rgb(5,61,96, maxColorValue = 255), size = 14, face = "bold"),
    axis.text = element_text(size=12),
    legend.key = element_rect(fill = rgb(242,242,242, maxColorValue = 255)),
    legend.background=element_blank(),
    legend.title=element_blank(),
    text=element_text(family="Century Gothic"),
    legend.position="bottom"
  )


ggplotly(pic)

#pic

```

## BCOM Weights {data-background="img/BlueBackgroundWithOrange.png"}

```{r}

bcomWeightsYear <-  as.data.table(read_csv("C:/Box/Polar Star - Company Folder/1. Polar Star/Analysis/Analysis and Research/code/debunking-long-only-commodity-investing/data/bcomWeightsYear.csv"))

bcomWeightsYear <- bcomWeightsYear[order(year, weight)]
bcomWeightsYear$comdty <- factor(bcomWeightsYear$comdty, levels = bcomWeightsYear[, unique(comdty)])


pic <- ggplot(bcomWeightsYear, aes(x=comdty, y=weight)) +
  geom_bar(stat = "identity", position=position_dodge(), aes(fill = factor(year))) +
  coord_flip() +
  scale_fill_brewer(palette="Accent") +
  scale_y_continuous(breaks = pretty_breaks(n=20)) +
  ylab("Weight (%)") +
  xlab("Commodity") +
  ggtitle("BCOM Index Commodity Weights by Year") +
  theme(
    plot.background = element_rect(fill = rgb(242,242,242, maxColorValue = 255)),
    panel.background = element_rect(fill = "white"),
    panel.grid.major.y = element_line(size = 0.5, linetype = 'solid',colour = "gray"),
    panel.grid.major.x = element_line(size = 0.5, linetype = 'dashed',colour = "gray"),
    axis.title.x = element_text(colour = rgb(5,61,96, maxColorValue = 255), size = 16),
    axis.title.y = element_text(colour = rgb(5,61,96, maxColorValue = 255), size = 16),
    plot.title = element_text(colour = rgb(5,61,96, maxColorValue = 255), size = 14, face = "bold"),
    axis.text = element_text(size=12),
    legend.key = element_rect(fill = rgb(242,242,242, maxColorValue = 255)),
    legend.background=element_blank(),
    legend.title=element_blank(),
    text=element_text(family="Century Gothic"),
    legend.position="bottom"
  )


ggplotly(pic)

#pic

```


## Aggregated Weights {data-background="img/BlueBackgroundWithOrange.png"}

```{r}

bcomWeights <- as.data.table(read_csv("C:/Box/Polar Star - Company Folder/1. Polar Star/Analysis/Analysis and Research/code/debunking-long-only-commodity-investing/data/bcomWeights.csv"))

bcomWeights <- bcomWeights[order(weight)]
bcomWeights$comdty <- factor(bcomWeights$comdty, levels = bcomWeights$comdty)

pic <- ggplot(bcomWeights, aes(x=comdty, y=weight)) +
  geom_bar(stat = "identity") +
  coord_flip() +
  ylab("Weight (%)") +
  xlab("Commodity") +
  scale_y_continuous(breaks = pretty_breaks(n=10)) +
  ggtitle("BCOM Index Commodity Weights by Year") +
  theme(
    plot.background = element_rect(fill = rgb(242,242,242, maxColorValue = 255)),
    panel.background = element_rect(fill = "white"),
    panel.grid.major.y = element_line(size = 0.5, linetype = 'solid',colour = "gray"),
    panel.grid.major.x = element_line(size = 0.5, linetype = 'dashed',colour = "gray"),
    axis.title.x = element_text(colour = rgb(5,61,96, maxColorValue = 255), size = 16),
    axis.title.y = element_text(colour = rgb(5,61,96, maxColorValue = 255), size = 16),
    plot.title = element_text(colour = rgb(5,61,96, maxColorValue = 255), size = 14, face = "bold"),
    axis.text = element_text(size=12),
    legend.key = element_rect(fill = rgb(242,242,242, maxColorValue = 255)),
    legend.background=element_blank(),
    legend.title=element_blank(),
    text=element_text(family="Century Gothic"),
    legend.position="bottom"
  )

ggplotly(pic)

#pic

```


# Curve Shape {data-background="img/background_mtns_1.png"}

## Contango {data-background="img/BlueBackgroundWithOrange.png"}


```{r}

curveShape <- as.data.table(read_csv("C:/Box/Polar Star - Company Folder/1. Polar Star/Analysis/Analysis and Research/code/debunking-long-only-commodity-investing/data/curveSahpe.csv"))

```

```{r}

plotdata <- curveShape[comdty == "C"]
plotdata <- plotdata[order(expiry)]

pic <- ggplot(plotdata, aes(x=expiry, y=price, group = comdty, text = paste(contract, "<br>", price))) +
  geom_point() +
  geom_line() +
  ggtitle("Curve in Contango: Corn Futures Curve 2019-06-12") +
  theme(
    plot.background = element_rect(fill = rgb(242,242,242, maxColorValue = 255)),
    panel.background = element_rect(fill = "white"),
    panel.grid.major.y = element_line(size = 0.5, linetype = 'solid',colour = "gray"),
    panel.grid.major.x = element_line(size = 0.5, linetype = 'dashed',colour = "gray"),
    axis.title.x = element_text(colour = rgb(5,61,96, maxColorValue = 255), size = 16),
    axis.title.y = element_text(colour = rgb(5,61,96, maxColorValue = 255), size = 16),
    plot.title = element_text(colour = rgb(5,61,96, maxColorValue = 255), size = 14, face = "bold"),
    axis.text = element_text(size=12),
    legend.key = element_rect(fill = rgb(242,242,242, maxColorValue = 255)),
    legend.background=element_blank(),
    legend.title=element_blank(),
    text=element_text(family="Century Gothic"),
    legend.position="bottom"
  )

ggplotly(pic, tooltip="text")

#pic

```

## Backwardation {data-background="img/BlueBackgroundWithOrange.png"}

```{r}

plotdata <- curveShape[comdty == "LX"]
plotdata <- plotdata[order(expiry)]

pic <- ggplot(plotdata, aes(x=expiry, y=price, group = comdty, text = paste(contract, "<br>", price))) +
  geom_point() +
  geom_line() +
  ggtitle("Curve in Backwardation: Zinc Futures Curve 2019-06-12") +
  theme(
    plot.background = element_rect(fill = rgb(242,242,242, maxColorValue = 255)),
    panel.background = element_rect(fill = "white"),
    panel.grid.major.y = element_line(size = 0.5, linetype = 'solid',colour = "gray"),
    panel.grid.major.x = element_line(size = 0.5, linetype = 'dashed',colour = "gray"),
    axis.title.x = element_text(colour = rgb(5,61,96, maxColorValue = 255), size = 16),
    axis.title.y = element_text(colour = rgb(5,61,96, maxColorValue = 255), size = 16),
    plot.title = element_text(colour = rgb(5,61,96, maxColorValue = 255), size = 14, face = "bold"),
    axis.text = element_text(size=12),
    legend.key = element_rect(fill = rgb(242,242,242, maxColorValue = 255)),
    legend.background=element_blank(),
    legend.title=element_blank(),
    text=element_text(family="Century Gothic"),
    legend.position="bottom"
  )

ggplotly(pic, tooltip="text")

#pic

```


## The effect of roll yield - Corn {data-background="img/BlueBackgroundWithOrange.png"}

```{r}

rolledPrices <- as.data.table(read_csv("C:/Box/Polar Star - Company Folder/1. Polar Star/Analysis/Analysis and Research/code/debunking-long-only-commodity-investing/data/rolledPrices.csv"))

```

```{r}

cmdt <- "C"
  
plotdata <- rolledPrices[comdty == cmdt, .(date, price, `adj price`)]
plotdata <- melt(plotdata, id.vars = "date", variable.name = "Price Series", value.name = "Price")
  
pic <- ggplot(plotdata, aes(x=date, y=Price)) +
  geom_line(aes(group = `Price Series`, color = `Price Series`)) +
  scale_y_continuous(breaks = pretty_breaks(n=10)) +
  scale_x_date(breaks = pretty_breaks(n=10)) +
  scale_color_brewer(palette="Accent") +
  ggtitle(paste(cmdt, "Adjusted and Normal Price Series")) +
  theme(
    plot.background = element_rect(fill = rgb(242,242,242, maxColorValue = 255)),
    panel.background = element_rect(fill = "white"),
    panel.grid.major.y = element_line(size = 0.5, linetype = 'solid',colour = "gray"),
    panel.grid.major.x = element_line(size = 0.5, linetype = 'dashed',colour = "gray"),
    axis.title.x = element_text(colour = rgb(5,61,96, maxColorValue = 255), size = 16),
    axis.title.y = element_text(colour = rgb(5,61,96, maxColorValue = 255), size = 16),
    plot.title = element_text(colour = rgb(5,61,96, maxColorValue = 255), size = 14, face = "bold"),
    axis.text = element_text(size=12),
    legend.key = element_rect(fill = rgb(242,242,242, maxColorValue = 255)),
    legend.background=element_blank(),
    legend.title=element_blank(),
    text=element_text(family="Century Gothic"),
    legend.position="bottom"
  )

ggplotly(pic) %>%
    layout(legend = list(orientation = "h", x = 0.4, y = -0.2))

#pic

```

## The effect of roll yield - Natural Gas {data-background="img/BlueBackgroundWithOrange.png"}


```{r}

cmdt <- "NG"
  
plotdata <- rolledPrices[comdty == cmdt, .(date, price, `adj price`)]
plotdata <- melt(plotdata, id.vars = "date", variable.name = "Price Series", value.name = "Price")
  
pic <- ggplot(plotdata, aes(x=date, y=Price)) +
  geom_line(aes(group = `Price Series`, color = `Price Series`)) +
  scale_y_continuous(breaks = pretty_breaks(n=10)) +
  scale_x_date(breaks = pretty_breaks(n=10)) +
  scale_color_brewer(palette="Accent") +
  ggtitle(paste(cmdt, "Adjusted and Normal Price Series")) +
  theme(
    plot.background = element_rect(fill = rgb(242,242,242, maxColorValue = 255)),
    panel.background = element_rect(fill = "white"),
    panel.grid.major.y = element_line(size = 0.5, linetype = 'solid',colour = "gray"),
    panel.grid.major.x = element_line(size = 0.5, linetype = 'dashed',colour = "gray"),
    axis.title.x = element_text(colour = rgb(5,61,96, maxColorValue = 255), size = 16),
    axis.title.y = element_text(colour = rgb(5,61,96, maxColorValue = 255), size = 16),
    plot.title = element_text(colour = rgb(5,61,96, maxColorValue = 255), size = 14, face = "bold"),
    axis.text = element_text(size=12),
    legend.key = element_rect(fill = rgb(242,242,242, maxColorValue = 255)),
    legend.background=element_blank(),
    legend.title=element_blank(),
    text=element_text(family="Century Gothic"),
    legend.position="bottom"
  )

ggplotly(pic) %>%
    layout(legend = list(orientation = "h", x = 0.4, y = -0.2))

#pic

```

## The effect of roll yield - Chicago Wheat {data-background="img/BlueBackgroundWithOrange.png"}


```{r}

cmdt <- "W"
  
plotdata <- rolledPrices[comdty == cmdt, .(date, price, `adj price`)]
plotdata <- melt(plotdata, id.vars = "date", variable.name = "Price Series", value.name = "Price")
  
pic <- ggplot(plotdata, aes(x=date, y=Price)) +
  geom_line(aes(group = `Price Series`, color = `Price Series`)) +
  scale_y_continuous(breaks = pretty_breaks(n=10)) +
  scale_x_date(breaks = pretty_breaks(n=10)) +
  scale_color_brewer(palette="Accent") +
  ggtitle(paste(cmdt, "Adjusted and Normal Price Series")) +
  theme(
    plot.background = element_rect(fill = rgb(242,242,242, maxColorValue = 255)),
    panel.background = element_rect(fill = "white"),
    panel.grid.major.y = element_line(size = 0.5, linetype = 'solid',colour = "gray"),
    panel.grid.major.x = element_line(size = 0.5, linetype = 'dashed',colour = "gray"),
    axis.title.x = element_text(colour = rgb(5,61,96, maxColorValue = 255), size = 16),
    axis.title.y = element_text(colour = rgb(5,61,96, maxColorValue = 255), size = 16),
    plot.title = element_text(colour = rgb(5,61,96, maxColorValue = 255), size = 14, face = "bold"),
    axis.text = element_text(size=12),
    legend.key = element_rect(fill = rgb(242,242,242, maxColorValue = 255)),
    legend.background=element_blank(),
    legend.title=element_blank(),
    text=element_text(family="Century Gothic"),
    legend.position="bottom"
  )

ggplotly(pic) %>%
    layout(legend = list(orientation = "h", x = 0.4, y = -0.2))

#pic

```


## The effect of roll yield - Arabica Coffee {data-background="img/BlueBackgroundWithOrange.png"}


```{r}

cmdt <- "KC"
  
plotdata <- rolledPrices[comdty == cmdt, .(date, price, `adj price`)]
plotdata <- melt(plotdata, id.vars = "date", variable.name = "Price Series", value.name = "Price")
  
pic <- ggplot(plotdata, aes(x=date, y=Price)) +
  geom_line(aes(group = `Price Series`, color = `Price Series`)) +
  scale_y_continuous(breaks = pretty_breaks(n=10)) +
  scale_x_date(breaks = pretty_breaks(n=10)) +
  scale_color_brewer(palette="Accent") +
  ggtitle(paste(cmdt, "Adjusted and Normal Price Series")) +
  theme(
    plot.background = element_rect(fill = rgb(242,242,242, maxColorValue = 255)),
    panel.background = element_rect(fill = "white"),
    panel.grid.major.y = element_line(size = 0.5, linetype = 'solid',colour = "gray"),
    panel.grid.major.x = element_line(size = 0.5, linetype = 'dashed',colour = "gray"),
    axis.title.x = element_text(colour = rgb(5,61,96, maxColorValue = 255), size = 16),
    axis.title.y = element_text(colour = rgb(5,61,96, maxColorValue = 255), size = 16),
    plot.title = element_text(colour = rgb(5,61,96, maxColorValue = 255), size = 14, face = "bold"),
    axis.text = element_text(size=12),
    legend.key = element_rect(fill = rgb(242,242,242, maxColorValue = 255)),
    legend.background=element_blank(),
    legend.title=element_blank(),
    text=element_text(family="Century Gothic"),
    legend.position="bottom"
  )

ggplotly(pic) %>%
    layout(legend = list(orientation = "h", x = 0.4, y = -0.2))

#pic

```




# Index Proxy {data-background="img/background_mtns_1.png"} 


```{r}

# define a function that determines the return statistiscs

getStatistics <- function(df){
  
  output <- vector(mode = "list", length = 7)
  
  df[, year := year(date)]
  
  ## RETURN STATISTICS
  # last month returns
  lastmonth <- round(df[nrow(df), return] * 100, 2)
  
  # year to date returns
  tempdata <- df[year == max(year)]
  y2d <- round(tempdata[, prod(return + 1) - 1], 2)
  
  # 3 month return
  tempdata <- df[(nrow(df)-2):nrow(df)]
  ROR3month <- round(tempdata[, prod(return + 1) - 1] * 100, 2)
  
  # 12 month return
  if(nrow(df) < 12){
    ROR12month <- NA
  }else{
    tempdata <- df[(nrow(df)-11):nrow(df)]
    ROR12month <- round(tempdata[, prod(return + 1) - 1] * 100, 2)
  }
    
  # 36 month return
  if(nrow(df) < 36){
    ROR36month <- NA
  }else{
    tempdata <- df[(nrow(df)-35):nrow(df)]
    ROR36month <- round(tempdata[, prod(return + 1) - 1] * 100, 2)
  }
  
  
  # total return
  totalreturn <- round(df[, prod(return + 1) - 1] * 100, 2)
  
  # compound ROR
  compoundROR <- table.AnnualizedReturns(df[,.(date, return)])
  compoundROR <- round(compoundROR[1,1] * 100, 2)

  # best month
  bestmonth <- round(df[, max(return)] * 100, 2)
  
  # winning months
  df[, sign := sign(return)]
  winningmonths <- round(nrow(df[sign == 1])/nrow(df) * 100, 2)
  df[, sign := NULL]
  
  returnStatistics <- data.table(
    statistic = c(
      "Last Month", 
      "Year To Date",
      "3 Month ROR", 
      "12 Month ROR", 
      "36 Month ROR", 
      "Total Return", 
      "Compound ROR", 
      "Best Month", 
      "Winning Months (%)"),
    values = c(
     lastmonth,
     y2d,
     ROR3month,
     ROR12month,
     ROR36month,
     totalreturn,
     compoundROR,
     bestmonth,
     winningmonths
    )
  )
  
  
  output[[1]] <- returnStatistics
  
  ## RISK STATISTICS
  # annual std
  stdev <- table.AnnualizedReturns(df[,.(date, return)])
  stdev <- round(stdev[2,1] * 100, 2)
  
  # max drawdown
  maxdraw <- round(maxDrawdown(as.xts(df[,.(date, return)])) * 100, 2)
  
  # months to recover
  tempdata <- as.data.table(table.Drawdowns(as.xts(df[, .(date, return)])))
  monthstorecover <- tempdata[1, Length]
  
  # worst month
  worstmonth <- round(df[return == min(return), return] * 100, 2)
  
  # losing months
  df[, sign := sign(return)]
  losingmonths <- round(nrow(df[sign == -1])/nrow(df) * 100, 2)
  df[, sign := NULL]
  
  # average losing month
  averagelosing <- round(df[return < 0, mean(return)] * 100, 2)
  
  # loss deviation
  lossdeviation <- round(df[return <0, sd(return)] * 100, 2)
  
  
  riskStatistics <- data.table(
    statistic = c(
      "Annualized Std.Deviation",
      "Maximum Drawdown", 
      "Month to Recover",
      "Worst Month",
      "Losing Months (%)",
      "Average Losing Month",
      "Loss Deviation"
    ),
    value = c(
      stdev,
      maxdraw,
      monthstorecover,
      worstmonth,
      losingmonths,
      averagelosing,
      lossdeviation
    )
  )
  
  riskStatistics[, value := round(value, 2)]
  
  output[[2]] <- riskStatistics
  
  ## RISK/REWARD STATISTICS
  sharpe <- SharpeRatio(df[, .(date, return)], annualize = TRUE, FUN = "StdDev")[1]
  sortino <- compoundROR/(lossdeviation * sqrt(12))
  omega <- OmegaSharpeRatio(df[,.(date, return)], annualize = TRUE)
  skw <- skewness(as.xts(df[,.(date, return)]))
  krt <- kurtosis(as.xts(df[,.(date, return)]), method = "fisher")
  
  riskRewardStatistics <- data.table(
    statistic = c(
      "Sharpe Ratio", 
      "Sortino Ratio",
      "Omega Ratio",
      "Skewness", 
      "Kurtosis"
    ),
    value = c(
      sharpe,
      sortino,
      omega,
      skw,
      krt
    )
  )
  
  riskRewardStatistics[, value := round(value, 2)]
  
  output[[3]] <- riskRewardStatistics
  
  ## RETURN REPORT
  # 1 month
  rr1month <- df[, .(Period = "1 Month",
         Best = round(max(return)*100,2), 
         Worst = round(min(return)*100,2), 
         Average = round(mean(return)*100,2), 
         Median = round(median(return)*100,2), 
         Last = lastmonth, 
         `Winning (%)` = winningmonths, 
         `Avg. Pos. Period` = round(df[return > 0, mean(return)] * 100, 2), 
         `Avg. Neg. Period` = round(df[return < 0, mean(return)] * 100, 2),
         `# Of Periods` = nrow(df))]
  
  # 3 month
  tempdata <- df[, .(date, return)]
  rollingreturn <- rollapply(tempdata[, return+1], 3, FUN = prod) - 1
  
  rr3month <- data.table(
    Period = "3 Month",
    Best = round(max(rollingreturn) * 100, 2), 
    Worst = round(min(rollingreturn) * 100, 2), 
    Average = round(mean(rollingreturn) * 100, 2), 
    Median = round(median(rollingreturn) * 100, 2), 
    Last = round(rollingreturn[length(rollingreturn)]*100,2),
    `Winning (%)` = round(length(rollingreturn[rollingreturn > 0])/length(rollingreturn)*100,2),
    `Avg. Pos. Period` = round(mean(rollingreturn[rollingreturn > 0])*100, 2),
    `Avg. Neg. Period` = round(mean(rollingreturn[rollingreturn < 0])*100, 2),
    `# Of Periods` = length(rollingreturn)
  )
  
  # 6 month
  tempdata <- df[, .(date, return)]
  rollingreturn <- rollapply(tempdata[, return+1], 6, FUN = prod) - 1
  
  if(length(rollingreturn) == 0){
    rr6month <- data.table(
      Period = "6 Month",
      Best = NA, 
      Worst = NA, 
      Average = NA, 
      Median = NA, 
      Last = NA,
      `Winning (%)` = NA,
      `Avg. Pos. Period` = NA,
      `Avg. Neg. Period` = NA,
      `# Of Periods` = NA
    )
  }else{
    rr6month <- data.table(
      Period = "6 Month",
      Best = round(max(rollingreturn) * 100, 2), 
      Worst = round(min(rollingreturn) * 100, 2), 
      Average = round(mean(rollingreturn) * 100, 2), 
      Median = round(median(rollingreturn) * 100, 2), 
      Last = round(rollingreturn[length(rollingreturn)]*100,2),
      `Winning (%)` = round(length(rollingreturn[rollingreturn > 0])/length(rollingreturn)*100,2),
      `Avg. Pos. Period` = round(mean(rollingreturn[rollingreturn > 0])*100, 2),
      `Avg. Neg. Period` = round(mean(rollingreturn[rollingreturn < 0])*100, 2),
      `# Of Periods` = length(rollingreturn)
    )  
  }
  
  
  # 1 year 
  tempdata <- df[, .(date, return)]
  rollingreturn <- rollapply(tempdata[, return+1], 12, FUN = prod) - 1
  
  if(length(rollingreturn) == 0){
    rr1year <- data.table(
      Period = "1 Year",
      Best = NA, 
      Worst = NA, 
      Average = NA, 
      Median = NA, 
      Last = NA,
      `Winning (%)` = NA,
      `Avg. Pos. Period` = NA,
      `Avg. Neg. Period` = NA,
      `# Of Periods` = NA
    )
  }else{
    rr1year <- data.table(
      Period = "1 Year",
      Best = round(max(rollingreturn) * 100, 2), 
      Worst = round(min(rollingreturn) * 100, 2), 
      Average = round(mean(rollingreturn) * 100, 2), 
      Median = round(median(rollingreturn) * 100, 2), 
      Last = round(rollingreturn[length(rollingreturn)]*100,2),
      `Winning (%)` = round(length(rollingreturn[rollingreturn > 0])/length(rollingreturn)*100,2),
      `Avg. Pos. Period` = round(mean(rollingreturn[rollingreturn > 0])*100, 2),
      `Avg. Neg. Period` = round(mean(rollingreturn[rollingreturn < 0])*100, 2),
      `# Of Periods` = length(rollingreturn)
    )
  }
  
  
  
  # 2 year 
  tempdata <- df[, .(date, return)]
  rollingreturn <- rollapply(tempdata[, return+1], 12 * 2, FUN = prod) - 1
  
  if(length(rollingreturn) == 0){
    rr2year <- data.table(
      Period = "2 Year",
      Best = NA, 
      Worst = NA, 
      Average = NA, 
      Median = NA, 
      Last = NA,
      `Winning (%)` = NA,
      `Avg. Pos. Period` = NA,
      `Avg. Neg. Period` = NA,
      `# Of Periods` = NA
    )
  }else{
    rr2year <- data.table(
      Period = "2 Year",
      Best = round(max(rollingreturn) * 100, 2), 
      Worst = round(min(rollingreturn) * 100, 2), 
      Average = round(mean(rollingreturn) * 100, 2), 
      Median = round(median(rollingreturn) * 100, 2), 
      Last = round(rollingreturn[length(rollingreturn)]*100,2),
      `Winning (%)` = round(length(rollingreturn[rollingreturn > 0])/length(rollingreturn)*100,2),
      `Avg. Pos. Period` = round(mean(rollingreturn[rollingreturn > 0])*100, 2),
      `Avg. Neg. Period` = round(mean(rollingreturn[rollingreturn < 0])*100, 2),
      `# Of Periods` = length(rollingreturn)
    )
  }
  
  # 3 year 
  tempdata <- df[, .(date, return)]
  rollingreturn <- rollapply(tempdata[, return+1], 12 * 3, FUN = prod) - 1
  
  if(length(rollingreturn) == 0){
    rr3year <- data.table(
      Period = "3 Year",
      Best = NA, 
      Worst = NA, 
      Average = NA, 
      Median = NA, 
      Last = NA,
      `Winning (%)` = NA,
      `Avg. Pos. Period` = NA,
      `Avg. Neg. Period` = NA,
      `# Of Periods` = NA
    )
  }else{
    rr3year <- data.table(
      Period = "3 Year",
      Best = round(max(rollingreturn) * 100, 2), 
      Worst = round(min(rollingreturn) * 100, 2), 
      Average = round(mean(rollingreturn) * 100, 2), 
      Median = round(median(rollingreturn) * 100, 2), 
      Last = round(rollingreturn[length(rollingreturn)]*100,2),
      `Winning (%)` = round(length(rollingreturn[rollingreturn > 0])/length(rollingreturn)*100,2),
      `Avg. Pos. Period` = round(mean(rollingreturn[rollingreturn > 0])*100, 2),
      `Avg. Neg. Period` = round(mean(rollingreturn[rollingreturn < 0])*100, 2),
      `# Of Periods` = length(rollingreturn)
    )
  }
  
  # 5 year 
  tempdata <- df[, .(date, return)]
  rollingreturn <- rollapply(tempdata[, return+1], 12 * 5, FUN = prod) - 1
  
  if(length(rollingreturn) == 0){
    rr5year <- data.table(
      Period = "5 Year",
      Best = NA, 
      Worst = NA, 
      Average = NA, 
      Median = NA, 
      Last = NA,
      `Winning (%)` = NA,
      `Avg. Pos. Period` = NA,
      `Avg. Neg. Period` = NA,
      `# Of Periods` = NA
    )
  }else{
    rr5year <- data.table(
      Period = "5 Year",
      Best = round(max(rollingreturn) * 100, 2), 
      Worst = round(min(rollingreturn) * 100, 2), 
      Average = round(mean(rollingreturn) * 100, 2), 
      Median = round(median(rollingreturn) * 100, 2), 
      Last = round(rollingreturn[length(rollingreturn)]*100,2),
      `Winning (%)` = round(length(rollingreturn[rollingreturn > 0])/length(rollingreturn)*100,2),
      `Avg. Pos. Period` = round(mean(rollingreturn[rollingreturn > 0])*100, 2),
      `Avg. Neg. Period` = round(mean(rollingreturn[rollingreturn < 0])*100, 2),
      `# Of Periods` = length(rollingreturn)
    )
  }
  
  returnReport <- rbind(
    rr1month,
    rr3month,
    rr6month,
    rr1year,
    rr2year,
    rr3year,
    rr5year
  )
  
  
  output[[4]] <- returnReport
  
  ## DRAWDOWN REPORT
  drawdownReport <- table.Drawdowns(as.xts(df[, .(date, return)]))
  drawdownReport <- as.data.table(drawdownReport)
  drawdownReport[, Depth := round(Depth * 100,2)]
  drawdownReport[, Number := 1:nrow(drawdownReport)]
  drawdownReport <- drawdownReport[, .(Number, `Depth (%)` = Depth, `Length (Months)` = Length, `Recovery (Months)` = Recovery, Start = From, End = To)]
  
  
  output[[5]] <- drawdownReport
  
  ## TIME WINDOW ANALYSIS
  returnReport$Period <- factor(returnReport$Period, levels = returnReport$Period)
  tempdata <- melt(returnReport, id.vars = "Period")
  
  timeWindowAnalysis <- dcast(tempdata, variable ~ Period, value.var = "value")
 
   
  output[[6]] <- timeWindowAnalysis
  
  output
}


```

## Index Proxy vs BCOM {data-background="img/BlueBackgroundWithOrange.png"}

```{r}

backtestPnL <- as.data.table(read_csv("C:/Box/Polar Star - Company Folder/1. Polar Star/Analysis/Analysis and Research/code/debunking-long-only-commodity-investing/data/backtestPnL.csv"))

bcomData[, normalise := BCOM/bcomData[1, BCOM]]

plotdata <- merge(backtestPnL[, .(date, backtest = normalised)], bcomData[, .(date, BCOM = normalise)], by = "date")
plotdata <- melt(plotdata, id.vars = "date", variable.name = "Timeseries")

pic <- ggplot(plotdata, aes(x=date, y=value, group=Timeseries)) +
  geom_line(aes(color = Timeseries)) +
  scale_color_brewer(palette="Accent") +
  xlab("") +
  ylab("Performance") +
  ggtitle("Value of $1 invested at inception") +
  scale_x_date(breaks = pretty_breaks(n=15)) +
  scale_y_continuous(breaks = pretty_breaks(n=10)) +
  theme(
    plot.background = element_rect(fill = rgb(242,242,242, maxColorValue = 255)),
    panel.background = element_rect(fill = "white"),
    panel.grid.major.y = element_line(size = 0.5, linetype = 'solid',colour = "gray"),
    panel.grid.major.x = element_line(size = 0.5, linetype = 'dashed',colour = "gray"),
    axis.title.x = element_text(colour = rgb(5,61,96, maxColorValue = 255), size = 16),
    axis.title.y = element_text(colour = rgb(5,61,96, maxColorValue = 255), size = 16),
    plot.title = element_text(colour = rgb(5,61,96, maxColorValue = 255), size = 14, face = "bold"),
    axis.text = element_text(size=12),
    legend.key = element_rect(fill = rgb(242,242,242, maxColorValue = 255)),
    legend.background=element_blank(),
    legend.title=element_blank(),
    text=element_text(family="Century Gothic"),
    legend.position="bottom"
  )


ggplotly(pic) %>%
    layout(legend = list(orientation = "h", x = 0.4, y = -0.2))

#pic

```


## Index Proxy - Risk and Return Statistics {data-background="img/BlueBackgroundWithOrange.png"}

```{r}

backtestPnL[, year := year(date)]
backtestPnL[, month := month(date)]
backtestPnL[, md := max(date), by = .(year, month)]

monthlyPnL <- backtestPnL[date == md]

returndf <- CalculateReturns(monthlyPnL[, .(date, PnL)])
returndf <- as.data.table(returndf)
setnames(returndf, names(returndf), c("date", "return"))
returndf <- returndf[!is.na(return)]

backteststats <- getStatistics(returndf)

```


```{r}

tbl <- backteststats[[3]]
setnames(tbl, "value", "Risk/Reward Statistics")

nms <- tbl$statistic

tbl <- as.data.frame(tbl[, 2:ncol(tbl), with = FALSE])
row.names(tbl) <- nms

#rhandsontable(tbl, rowHeaderWidth = 200)

kable(tbl) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), font_size = 12, full_width = F, position = "float_left")

```



```{r}

tbl <- backteststats[[2]]
setnames(tbl, "value", "Risk Statistics")

nms <- tbl$statistic

tbl <- as.data.frame(tbl[, 2:ncol(tbl), with = FALSE])
row.names(tbl) <- nms

#rhandsontable(tbl, rowHeaderWidth = 200)

kable(tbl) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), font_size = 12, full_width = F, position = "float_left")

```


```{r}

tbl <- backteststats[[1]]
setnames(tbl, "values", "Return Statistics")

nms <- tbl$statistic

tbl <- as.data.frame(tbl[, 2:ncol(tbl), with = FALSE])
row.names(tbl) <- nms

#rhandsontable(tbl, rowHeaderWidth = 200)

kable(tbl) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), font_size = 12, full_width = F, position = "float_left")

```

## Index Proxy - Time Windown Report {data-background="img/BlueBackgroundWithOrange.png"}

Time Window Analysis:

```{r}

tbl <- backteststats[[6]]

nms <- tbl$variable

tbl <- as.data.frame(tbl[, 2:ncol(tbl), with = FALSE])
row.names(tbl) <- nms

#rhandsontable(tbl, rowHeaderWidth = 200)

kable(tbl) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), font_size = 12, full_width = T , position = "left")

```

Drawdown Report:

```{r}

tbl <- backteststats[[5]]

nms <- tbl$Number

tbl <- as.data.frame(tbl[, 2:ncol(tbl), with = FALSE])
row.names(tbl) <- nms

#rhandsontable(tbl, rowHeaderWidth = 200)

kable(tbl) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), font_size = 12, full_width = T, position = "left")

```


## Index Proxy Performance Attribution - WTI Crude Oil {data-background="img/BlueBackgroundWithOrange.png"}


```{r}

attribution <- as.data.table(read_csv("C:/Box/Polar Star - Company Folder/1. Polar Star/Analysis/Analysis and Research/code/debunking-long-only-commodity-investing/data/backtest_attribution.csv"))
attribution <- attribution[!is.na(cumret), .(date, comdty, cumret, linear)]

backwardation_contango <- as.data.table(read_csv("C:/Box/Polar Star - Company Folder/1. Polar Star/Analysis/Analysis and Research/code/debunking-long-only-commodity-investing/data/backwardation_contango.csv"))

backwardation_contango[, shape := ifelse(spread < 0, "Contango", "Backwardation")]


attribution <- merge(attribution, backwardation_contango, by = c("date", "comdty"), all.x = TRUE)

```

```{r}

cmdt <- "CL"
  
plotdata <- attribution[comdty == cmdt]
  
pic <- ggplot(plotdata, aes(x=date, y=linear)) +
  geom_line(aes(group = comdty)) +
  geom_point(aes(color = shape)) +  
  scale_y_continuous(breaks = pretty_breaks(n=10)) +
  scale_x_date(breaks = pretty_breaks(n=10)) +
  scale_color_brewer(palette="Accent") +
  ggtitle(paste(cmdt, " performance attribution with curve shapes")) +
  theme(
    plot.background = element_rect(fill = rgb(242,242,242, maxColorValue = 255)),
    panel.background = element_rect(fill = "white"),
    panel.grid.major.y = element_line(size = 0.5, linetype = 'solid',colour = "gray"),
    panel.grid.major.x = element_line(size = 0.5, linetype = 'dashed',colour = "gray"),
    axis.title.x = element_text(colour = rgb(5,61,96, maxColorValue = 255), size = 16),
    axis.title.y = element_text(colour = rgb(5,61,96, maxColorValue = 255), size = 16),
    plot.title = element_text(colour = rgb(5,61,96, maxColorValue = 255), size = 14, face = "bold"),
    axis.text = element_text(size=12),
    legend.key = element_rect(fill = rgb(242,242,242, maxColorValue = 255)),
    legend.background=element_blank(),
    legend.title=element_blank(),
    text=element_text(family="Century Gothic"),
    legend.position="bottom"
  )

ggplotly(pic) %>%
    layout(legend = list(orientation = "h", x = 0.4, y = -0.2))

```


## Index Proxy Performance Attribution - Arabic Coffee {data-background="img/BlueBackgroundWithOrange.png"}


```{r}

cmdt <- "KC"
  
plotdata <- attribution[comdty == cmdt]
  
pic <- ggplot(plotdata, aes(x=date, y=linear)) +
  geom_line(aes(group = comdty)) +
  geom_point(aes(color = shape)) +  
  scale_y_continuous(breaks = pretty_breaks(n=10)) +
  scale_x_date(breaks = pretty_breaks(n=10)) +
  scale_color_brewer(palette="Accent") +
  ggtitle(paste(cmdt, " performance attribution with curve shapes")) +
  theme(
    plot.background = element_rect(fill = rgb(242,242,242, maxColorValue = 255)),
    panel.background = element_rect(fill = "white"),
    panel.grid.major.y = element_line(size = 0.5, linetype = 'solid',colour = "gray"),
    panel.grid.major.x = element_line(size = 0.5, linetype = 'dashed',colour = "gray"),
    axis.title.x = element_text(colour = rgb(5,61,96, maxColorValue = 255), size = 16),
    axis.title.y = element_text(colour = rgb(5,61,96, maxColorValue = 255), size = 16),
    plot.title = element_text(colour = rgb(5,61,96, maxColorValue = 255), size = 14, face = "bold"),
    axis.text = element_text(size=12),
    legend.key = element_rect(fill = rgb(242,242,242, maxColorValue = 255)),
    legend.background=element_blank(),
    legend.title=element_blank(),
    text=element_text(family="Century Gothic"),
    legend.position="bottom"
  )

ggplotly(pic) %>%
    layout(legend = list(orientation = "h", x = 0.4, y = -0.2))

```

## Index Proxy Performance Attribution - Corn {data-background="img/BlueBackgroundWithOrange.png"}


```{r}

cmdt <- "C"
  
plotdata <- attribution[comdty == cmdt]
  
pic <- ggplot(plotdata, aes(x=date, y=linear)) +
  geom_line(aes(group = comdty)) +
  geom_point(aes(color = shape)) +  
  scale_y_continuous(breaks = pretty_breaks(n=10)) +
  scale_x_date(breaks = pretty_breaks(n=10)) +
  scale_color_brewer(palette="Accent") +
  ggtitle(paste(cmdt, " performance attribution with curve shapes")) +
  theme(
    plot.background = element_rect(fill = rgb(242,242,242, maxColorValue = 255)),
    panel.background = element_rect(fill = "white"),
    panel.grid.major.y = element_line(size = 0.5, linetype = 'solid',colour = "gray"),
    panel.grid.major.x = element_line(size = 0.5, linetype = 'dashed',colour = "gray"),
    axis.title.x = element_text(colour = rgb(5,61,96, maxColorValue = 255), size = 16),
    axis.title.y = element_text(colour = rgb(5,61,96, maxColorValue = 255), size = 16),
    plot.title = element_text(colour = rgb(5,61,96, maxColorValue = 255), size = 14, face = "bold"),
    axis.text = element_text(size=12),
    legend.key = element_rect(fill = rgb(242,242,242, maxColorValue = 255)),
    legend.background=element_blank(),
    legend.title=element_blank(),
    text=element_text(family="Century Gothic"),
    legend.position="bottom"
  )

ggplotly(pic) %>%
    layout(legend = list(orientation = "h", x = 0.4, y = -0.2))

```


# Long Backwardated Commodities {data-background="img/background_mtns_1.png"}

## Basic Idea {data-background="img/BlueBackgroundWithOrange.png"}

- Only take long exposure in those commodities whose curves are in backwardation
- Define the spread

$$
S_{C,K} := P_{C,K} - P_{C,K'}
$$

for each commodity $C$ as the price difference between the front contract $K$ and deferred contract, twelve months out from the front contract, $K'$.  

- If $S_{C,K}$ < 0 the curve is in contango
- If $S_{C,K}$ > 0 the curve is in backwardation



## Long Backwardated - Equity Curve {data-background="img/BlueBackgroundWithOrange.png"}

```{r}

backtestPnL_backwardation <- as.data.table(read_csv("C:/Box/Polar Star - Company Folder/1. Polar Star/Analysis/Analysis and Research/code/debunking-long-only-commodity-investing/data/backtestPnL_backwardation.csv"))


plotdata <- merge(backtestPnL_backwardation[, .(date, Backwardation = normalised)], backtestPnL[,.(date, `BCOM backtest` = normalised)], by = "date")

plotdata <- melt(plotdata, id.vars = "date", variable.name = "Timeseries")


pic <- ggplot(plotdata, aes(x=date, y=value, group=Timeseries)) +
  geom_line(aes(color = Timeseries)) +
  scale_color_brewer(palette="Accent") +
  xlab("") +
  ylab("Performance (log-scale)") +
  ggtitle("Value of $1 invested at inception") +
  scale_x_date(breaks = pretty_breaks(n=15)) +
  scale_y_log10() +
  theme(
    plot.background = element_rect(fill = rgb(242,242,242, maxColorValue = 255)),
    panel.background = element_rect(fill = "white"),
    panel.grid.major.y = element_line(size = 0.5, linetype = 'solid',colour = "gray"),
    panel.grid.major.x = element_line(size = 0.5, linetype = 'dashed',colour = "gray"),
    axis.title.x = element_text(colour = rgb(5,61,96, maxColorValue = 255), size = 16),
    axis.title.y = element_text(colour = rgb(5,61,96, maxColorValue = 255), size = 16),
    plot.title = element_text(colour = rgb(5,61,96, maxColorValue = 255), size = 14, face = "bold"),
    axis.text = element_text(size=12),
    legend.key = element_rect(fill = rgb(242,242,242, maxColorValue = 255)),
    legend.background=element_blank(),
    legend.title=element_blank(),
    text=element_text(family="Century Gothic"),
    legend.position="bottom"
  )


ggplotly(pic) %>%
    layout(legend = list(orientation = "h", x = 0.4, y = -0.2))



```


## Long Backwardated Commodities - Risk and Return Statistics {data-background="img/BlueBackgroundWithOrange.png"}

```{r}

backtestPnL_backwardation[, year := year(date)]
backtestPnL_backwardation[, month := month(date)]
backtestPnL_backwardation[, md := max(date), by = .(year, month)]

monthlyPnL <- backtestPnL_backwardation[date == md]

returndf <- CalculateReturns(monthlyPnL[, .(date, PnL)])
returndf <- as.data.table(returndf)
setnames(returndf, names(returndf), c("date", "return"))
returndf <- returndf[!is.na(return)]

backteststats <- getStatistics(returndf)

```

```{r}

tbl <- backteststats[[3]]
setnames(tbl, "value", "Risk/Reward Statistics")

nms <- tbl$statistic

tbl <- as.data.frame(tbl[, 2:ncol(tbl), with = FALSE])
row.names(tbl) <- nms

#rhandsontable(tbl, rowHeaderWidth = 200)

kable(tbl) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), font_size = 12, full_width = F, position = "float_left")

```



```{r}

tbl <- backteststats[[2]]
setnames(tbl, "value", "Risk Statistics")

nms <- tbl$statistic

tbl <- as.data.frame(tbl[, 2:ncol(tbl), with = FALSE])
row.names(tbl) <- nms

#rhandsontable(tbl, rowHeaderWidth = 200)

kable(tbl) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), font_size = 12, full_width = F, position = "float_left")

```


```{r}

tbl <- backteststats[[1]]
setnames(tbl, "values", "Return Statistics")

nms <- tbl$statistic

tbl <- as.data.frame(tbl[, 2:ncol(tbl), with = FALSE])
row.names(tbl) <- nms

#rhandsontable(tbl, rowHeaderWidth = 200)

kable(tbl) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), font_size = 12, full_width = F, position = "float_left")

```

## Long Backwardated Commodities - Time Windown Report {data-background="img/BlueBackgroundWithOrange.png"}

Time Window Analysis:

```{r}

tbl <- backteststats[[6]]

nms <- tbl$variable

tbl <- as.data.frame(tbl[, 2:ncol(tbl), with = FALSE])
row.names(tbl) <- nms

#rhandsontable(tbl, rowHeaderWidth = 200)

kable(tbl) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), font_size = 12, full_width = T , position = "left")

```

Drawdown Report:

```{r}

tbl <- backteststats[[5]]

nms <- tbl$Number

tbl <- as.data.frame(tbl[, 2:ncol(tbl), with = FALSE])
row.names(tbl) <- nms

#rhandsontable(tbl, rowHeaderWidth = 200)

kable(tbl) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), font_size = 12, full_width = T, position = "left")

```



# Short Contango Commodities {data-background="img/background_mtns_1.png"}
 
## Short Contango Commodities - Equity Curve {data-background="img/BlueBackgroundWithOrange.png"}


```{r}

backtestPnL_contango <- as.data.table(read_csv("C:/Box/Polar Star - Company Folder/1. Polar Star/Analysis/Analysis and Research/code/debunking-long-only-commodity-investing/data/backtestPnL_contango.csv"))


plotdata <- merge(backtestPnL_contango[, .(date, Contango = normalised)], backtestPnL[,.(date, `BCOM backtest` = normalised)], by = "date")

plotdata <- melt(plotdata, id.vars = "date", variable.name = "Timeseries")


pic <- ggplot(plotdata, aes(x=date, y=value, group=Timeseries)) +
  geom_line(aes(color = Timeseries)) +
  scale_color_brewer(palette="Accent") +
  xlab("") +
  ylab("Performance (log-scale)") +
  ggtitle("Value of $1 invested at inception") +
  scale_x_date(breaks = pretty_breaks(n=15)) +
  scale_y_log10() +
  theme(
    plot.background = element_rect(fill = rgb(242,242,242, maxColorValue = 255)),
    panel.background = element_rect(fill = "white"),
    panel.grid.major.y = element_line(size = 0.5, linetype = 'solid',colour = "gray"),
    panel.grid.major.x = element_line(size = 0.5, linetype = 'dashed',colour = "gray"),
    axis.title.x = element_text(colour = rgb(5,61,96, maxColorValue = 255), size = 16),
    axis.title.y = element_text(colour = rgb(5,61,96, maxColorValue = 255), size = 16),
    plot.title = element_text(colour = rgb(5,61,96, maxColorValue = 255), size = 14, face = "bold"),
    axis.text = element_text(size=12),
    legend.key = element_rect(fill = rgb(242,242,242, maxColorValue = 255)),
    legend.background=element_blank(),
    legend.title=element_blank(),
    text=element_text(family="Century Gothic"),
    legend.position="bottom"
  )


ggplotly(pic) %>%
    layout(legend = list(orientation = "h", x = 0.4, y = -0.2))



```




## Short Contango Commodities - Risk and Return Statistics {data-background="img/BlueBackgroundWithOrange.png"}

```{r}

backtestPnL_contango[, year := year(date)]
backtestPnL_contango[, month := month(date)]
backtestPnL_contango[, md := max(date), by = .(year, month)]

monthlyPnL <- backtestPnL_contango[date == md]

returndf <- CalculateReturns(monthlyPnL[, .(date, PnL)])
returndf <- as.data.table(returndf)
setnames(returndf, names(returndf), c("date", "return"))
returndf <- returndf[!is.na(return)]

backteststats <- getStatistics(returndf)

```

```{r}

tbl <- backteststats[[3]]
setnames(tbl, "value", "Risk/Reward Statistics")

nms <- tbl$statistic

tbl <- as.data.frame(tbl[, 2:ncol(tbl), with = FALSE])
row.names(tbl) <- nms

#rhandsontable(tbl, rowHeaderWidth = 200)

kable(tbl) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), font_size = 12, full_width = F, position = "float_left")

```



```{r}

tbl <- backteststats[[2]]
setnames(tbl, "value", "Risk Statistics")

nms <- tbl$statistic

tbl <- as.data.frame(tbl[, 2:ncol(tbl), with = FALSE])
row.names(tbl) <- nms

#rhandsontable(tbl, rowHeaderWidth = 200)

kable(tbl) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), font_size = 12, full_width = F, position = "float_left")

```


```{r}

tbl <- backteststats[[1]]
setnames(tbl, "values", "Return Statistics")

nms <- tbl$statistic

tbl <- as.data.frame(tbl[, 2:ncol(tbl), with = FALSE])
row.names(tbl) <- nms

#rhandsontable(tbl, rowHeaderWidth = 200)

kable(tbl) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), font_size = 12, full_width = F, position = "float_left")

```

## Short Contango Commodities - Time Windown Report {data-background="img/BlueBackgroundWithOrange.png"}

Time Window Analysis:

```{r}

tbl <- backteststats[[6]]

nms <- tbl$variable

tbl <- as.data.frame(tbl[, 2:ncol(tbl), with = FALSE])
row.names(tbl) <- nms

#rhandsontable(tbl, rowHeaderWidth = 200)

kable(tbl) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), font_size = 12, full_width = T , position = "left")

```

Drawdown Report:

```{r}

tbl <- backteststats[[5]]

nms <- tbl$Number

tbl <- as.data.frame(tbl[, 2:ncol(tbl), with = FALSE])
row.names(tbl) <- nms

#rhandsontable(tbl, rowHeaderWidth = 200)

kable(tbl) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), font_size = 12, full_width = T, position = "left")

```




# Combination Portfolio {data-background="img/background_mtns_1.png"}


## Basic Idea {data-background="img/BlueBackgroundWithOrange.png"}

Here we combine the two ideas 

- Take long exposure in backwardated commodities 
- Take short exposure in contango commodities
- Keep the BCOM Index weights


## Combinationi Portfolio - Equity Curve {data-background="img/BlueBackgroundWithOrange.png"}

```{r}

backtestPnL_combo <- as.data.table(read_csv("C:/Box/Polar Star - Company Folder/1. Polar Star/Analysis/Analysis and Research/code/debunking-long-only-commodity-investing/data/backtestPnL_combo.csv"))


plotdata <- merge(backtestPnL_combo[, .(date, Combo = normalised)], backtestPnL[,.(date, `BCOM backtest` = normalised)], by = "date")

plotdata <- melt(plotdata, id.vars = "date", variable.name = "Timeseries")


pic <- ggplot(plotdata, aes(x=date, y=value, group=Timeseries)) +
  geom_line(aes(color = Timeseries)) +
  scale_color_brewer(palette="Accent") +
  xlab("") +
  ylab("Performance (log-scale)") +
  ggtitle("Value of $1 invested at inception") +
  scale_x_date(breaks = pretty_breaks(n=15)) +
  scale_y_log10() +
  theme(
    plot.background = element_rect(fill = rgb(242,242,242, maxColorValue = 255)),
    panel.background = element_rect(fill = "white"),
    panel.grid.major.y = element_line(size = 0.5, linetype = 'solid',colour = "gray"),
    panel.grid.major.x = element_line(size = 0.5, linetype = 'dashed',colour = "gray"),
    axis.title.x = element_text(colour = rgb(5,61,96, maxColorValue = 255), size = 16),
    axis.title.y = element_text(colour = rgb(5,61,96, maxColorValue = 255), size = 16),
    plot.title = element_text(colour = rgb(5,61,96, maxColorValue = 255), size = 14, face = "bold"),
    axis.text = element_text(size=12),
    legend.key = element_rect(fill = rgb(242,242,242, maxColorValue = 255)),
    legend.background=element_blank(),
    legend.title=element_blank(),
    text=element_text(family="Century Gothic"),
    legend.position="bottom"
  )


ggplotly(pic) %>%
    layout(legend = list(orientation = "h", x = 0.4, y = -0.2))



```





## Combination Portfolio - Risk and Return Statistics {data-background="img/BlueBackgroundWithOrange.png"}

```{r}

backtestPnL_combo[, year := year(date)]
backtestPnL_combo[, month := month(date)]
backtestPnL_combo[, md := max(date), by = .(year, month)]

monthlyPnL <- backtestPnL_combo[date == md]

returndf <- CalculateReturns(monthlyPnL[, .(date, PnL)])
returndf <- as.data.table(returndf)
setnames(returndf, names(returndf), c("date", "return"))
returndf <- returndf[!is.na(return)]

backteststats <- getStatistics(returndf)

```


```{r}

tbl <- backteststats[[3]]
setnames(tbl, "value", "Risk/Reward Statistics")

nms <- tbl$statistic

tbl <- as.data.frame(tbl[, 2:ncol(tbl), with = FALSE])
row.names(tbl) <- nms

#rhandsontable(tbl, rowHeaderWidth = 200)

kable(tbl) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), font_size = 12, full_width = F, position = "float_left")

```



```{r}

tbl <- backteststats[[2]]
setnames(tbl, "value", "Risk Statistics")

nms <- tbl$statistic

tbl <- as.data.frame(tbl[, 2:ncol(tbl), with = FALSE])
row.names(tbl) <- nms

#rhandsontable(tbl, rowHeaderWidth = 200)

kable(tbl) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), font_size = 12, full_width = F, position = "float_left")

```


```{r}

tbl <- backteststats[[1]]
setnames(tbl, "values", "Return Statistics")

nms <- tbl$statistic

tbl <- as.data.frame(tbl[, 2:ncol(tbl), with = FALSE])
row.names(tbl) <- nms

#rhandsontable(tbl, rowHeaderWidth = 200)

kable(tbl) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), font_size = 12, full_width = F, position = "float_left")

```

## Combination Portfolio - Time Windown Report {data-background="img/BlueBackgroundWithOrange.png"}

Time Window Analysis:

```{r}

tbl <- backteststats[[6]]

nms <- tbl$variable

tbl <- as.data.frame(tbl[, 2:ncol(tbl), with = FALSE])
row.names(tbl) <- nms

#rhandsontable(tbl, rowHeaderWidth = 200)

kable(tbl) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), font_size = 12, full_width = T , position = "left")

```

Drawdown Report:

```{r}

tbl <- backteststats[[5]]

nms <- tbl$Number

tbl <- as.data.frame(tbl[, 2:ncol(tbl), with = FALSE])
row.names(tbl) <- nms

#rhandsontable(tbl, rowHeaderWidth = 200)

kable(tbl) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), font_size = 12, full_width = T, position = "left")

```



# Trend System on BCOM Commodities {data-background="img/background_mtns_1.png"}


## Basic Idea {data-background="img/BlueBackgroundWithOrange.png"}

- Use the <a href="https://clever-stonebraker-da1d54.netlify.com/post/designing-a-trend-strategy/" target="_blank">Polar Star Trend System</a> on a universe defined by the BCOM commodities
- Added diversification by adding long and short positions in trending markets


## Trend System on BCOM Commodities - Equity Curve {data-background="img/BlueBackgroundWithOrange.png"}

```{r}

trend_BCOM_commodities <- as.data.table(read_csv("C:/Box/Polar Star - Company Folder/1. Polar Star/Analysis/Analysis and Research/code/debunking-long-only-commodity-investing/data/trend_BCOM_commodities.csv"))

trend_BCOM_commodities <- trend_BCOM_commodities[date > "1991-01-01"]
trend_BCOM_commodities[, return := return / 100]

trend_BCOM_commodities[, cumret := cumprod(return + 1)]
trend_BCOM_commodities[, normalised := cumret/trend_BCOM_commodities[1, cumret]]


trend_BCOM_commodities[, year := year(date)]
trend_BCOM_commodities[, month := month(date)]

trend_BCOM_commodities[, md := max(date), by = .(year, month)]

trend_BCOM_commodities_monthly <- trend_BCOM_commodities[date == md, .(date, normalised)]

trend_returndf <- CalculateReturns(trend_BCOM_commodities_monthly[, .(date, PnL = normalised)])
trend_returndf <- as.data.table(trend_returndf)
setnames(trend_returndf, names(trend_returndf), c("date", "return"))
trend_returndf <- trend_returndf[!is.na(return)]

backteststats <- getStatistics(trend_returndf)


```


```{r}

plotdata <- merge(trend_BCOM_commodities[, .(date, Trend = normalised)], backtestPnL[,.(date, `BCOM backtest` = normalised)], by = "date")

plotdata <- merge(plotdata, backtestPnL_backwardation[, .(date, Backwardation = normalised)], by = "date")

plotdata <- merge(plotdata, backtestPnL_combo[, .(date, Combo = normalised)], by = "date")


plotdata <- melt(plotdata, id.vars = "date", variable.name = "Timeseries")

pic <- ggplot(plotdata, aes(x=date, y=value, group=Timeseries)) +
  geom_line(aes(color = Timeseries)) +
  scale_color_brewer(palette="Accent") +
  xlab("") +
  ylab("Performance (log-scale)") +
  ggtitle("Value of $1 invested at inception") +
  scale_x_date(breaks = pretty_breaks(n=15)) +
  scale_y_log10() +
  theme(
    plot.background = element_rect(fill = rgb(242,242,242, maxColorValue = 255)),
    panel.background = element_rect(fill = "white"),
    panel.grid.major.y = element_line(size = 0.5, linetype = 'solid',colour = "gray"),
    panel.grid.major.x = element_line(size = 0.5, linetype = 'dashed',colour = "gray"),
    axis.title.x = element_text(colour = rgb(5,61,96, maxColorValue = 255), size = 16),
    axis.title.y = element_text(colour = rgb(5,61,96, maxColorValue = 255), size = 16),
    plot.title = element_text(colour = rgb(5,61,96, maxColorValue = 255), size = 14, face = "bold"),
    axis.text = element_text(size=12),
    legend.key = element_rect(fill = rgb(242,242,242, maxColorValue = 255)),
    legend.background=element_blank(),
    legend.title=element_blank(),
    text=element_text(family="Century Gothic"),
    legend.position="bottom"
  )


ggplotly(pic) %>%
    layout(legend = list(orientation = "h", x = 0.4, y = -0.2))



```



## Trend System on BCOM Commodities - Risk and Return Statistics {data-background="img/BlueBackgroundWithOrange.png"}


```{r}

tbl <- backteststats[[3]]
setnames(tbl, "value", "Risk/Reward Statistics")

nms <- tbl$statistic

tbl <- as.data.frame(tbl[, 2:ncol(tbl), with = FALSE])
row.names(tbl) <- nms

#rhandsontable(tbl, rowHeaderWidth = 200)

kable(tbl) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), font_size = 12, full_width = F, position = "float_left")

```



```{r}

tbl <- backteststats[[2]]
setnames(tbl, "value", "Risk Statistics")

nms <- tbl$statistic

tbl <- as.data.frame(tbl[, 2:ncol(tbl), with = FALSE])
row.names(tbl) <- nms

#rhandsontable(tbl, rowHeaderWidth = 200)

kable(tbl) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), font_size = 12, full_width = F, position = "float_left")

```


```{r}

tbl <- backteststats[[1]]
setnames(tbl, "values", "Return Statistics")

nms <- tbl$statistic

tbl <- as.data.frame(tbl[, 2:ncol(tbl), with = FALSE])
row.names(tbl) <- nms

#rhandsontable(tbl, rowHeaderWidth = 200)

kable(tbl) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), font_size = 12, full_width = F, position = "float_left")

```

## Trend System on BCOM Commodities - Time Windown Report {data-background="img/BlueBackgroundWithOrange.png"}

Time Window Analysis:

```{r}

tbl <- backteststats[[6]]

nms <- tbl$variable

tbl <- as.data.frame(tbl[, 2:ncol(tbl), with = FALSE])
row.names(tbl) <- nms

#rhandsontable(tbl, rowHeaderWidth = 200)

kable(tbl) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), font_size = 12, full_width = T , position = "left")

```

Drawdown Report:

```{r}

tbl <- backteststats[[5]]

nms <- tbl$Number

tbl <- as.data.frame(tbl[, 2:ncol(tbl), with = FALSE])
row.names(tbl) <- nms

#rhandsontable(tbl, rowHeaderWidth = 200)

kable(tbl) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), font_size = 12, full_width = T, position = "left")

```




# Trend System on Extended Universe of Commodities {data-background="img/background_mtns_1.png"}


## Basic Idea {data-background="img/BlueBackgroundWithOrange.png"}

- Use the <a href="https://clever-stonebraker-da1d54.netlify.com/post/designing-a-trend-strategy/" target="_blank">Polar Star Trend System</a> on an extended universe of commodities

- Diversification added by
    - Long and short positions in trending markets
    - Extended universe of commodities
    - Look at different parts of the curves



## Trend System on Extended Universe of Commodities - Equity Curve {data-background="img/BlueBackgroundWithOrange.png"}


```{r}

trendmorecommodities <- as.data.table(read_csv("C:/Box/Polar Star - Company Folder/1. Polar Star/Analysis/Analysis and Research/code/debunking-long-only-commodity-investing/data/trend_more_commodities.csv"))

trendmorecommodities <- trendmorecommodities[date > "1991-01-01"]
trendmorecommodities[, return := return / 100]

trendmorecommodities[, cumret := cumprod(return + 1)]
trendmorecommodities[, normalised := cumret/trendmorecommodities[1, cumret]]


trendmorecommodities[, year := year(date)]
trendmorecommodities[, month := month(date)]

trendmorecommodities[, md := max(date), by = .(year, month)]

trendmorecommodities_monthly <- trendmorecommodities[date == md, .(date, normalised)]

trend_returndf <- CalculateReturns(trendmorecommodities_monthly[, .(date, PnL = normalised)])
trend_returndf <- as.data.table(trend_returndf)
setnames(trend_returndf, names(trend_returndf), c("date", "return"))
trend_returndf <- trend_returndf[!is.na(return)]

backteststats <- getStatistics(trend_returndf)


```



```{r}

plotdata <- merge(trendmorecommodities[, .(date, Trend = normalised)], backtestPnL[,.(date, `BCOM backtest` = normalised)], by = "date")

plotdata <- merge(plotdata, trend_BCOM_commodities[, .(date, `Trend BCOM commodities` = normalised)], by = "date")

plotdata <- merge(plotdata, backtestPnL_backwardation[, .(date, Backwardation = normalised)], by = "date")

plotdata <- merge(plotdata, backtestPnL_combo[, .(date, Combo = normalised)], by = "date")


plotdata <- melt(plotdata, id.vars = "date", variable.name = "Timeseries")

pic <- ggplot(plotdata, aes(x=date, y=value, group=Timeseries)) +
  geom_line(aes(color = Timeseries)) +
  scale_color_brewer(palette="Accent") +
  xlab("") +
  ylab("Performance (log-scale)") +
  ggtitle("Value of $1 invested at inception") +
  scale_x_date(breaks = pretty_breaks(n=15)) +
  scale_y_log10() +
  theme(
    plot.background = element_rect(fill = rgb(242,242,242, maxColorValue = 255)),
    panel.background = element_rect(fill = "white"),
    panel.grid.major.y = element_line(size = 0.5, linetype = 'solid',colour = "gray"),
    panel.grid.major.x = element_line(size = 0.5, linetype = 'dashed',colour = "gray"),
    axis.title.x = element_text(colour = rgb(5,61,96, maxColorValue = 255), size = 16),
    axis.title.y = element_text(colour = rgb(5,61,96, maxColorValue = 255), size = 16),
    plot.title = element_text(colour = rgb(5,61,96, maxColorValue = 255), size = 14, face = "bold"),
    axis.text = element_text(size=12),
    legend.key = element_rect(fill = rgb(242,242,242, maxColorValue = 255)),
    legend.background=element_blank(),
    legend.title=element_blank(),
    text=element_text(family="Century Gothic"),
    legend.position="bottom"
  )


ggplotly(pic) %>%
    layout(legend = list(orientation = "h", x = 0.4, y = -0.2))



```



## Trend System on Extended Universe of Commodities - Risk and Return Statistics {data-background="img/BlueBackgroundWithOrange.png"}


```{r}

tbl <- backteststats[[3]]
setnames(tbl, "value", "Risk/Reward Statistics")

nms <- tbl$statistic

tbl <- as.data.frame(tbl[, 2:ncol(tbl), with = FALSE])
row.names(tbl) <- nms

#rhandsontable(tbl, rowHeaderWidth = 200)

kable(tbl) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), font_size = 12, full_width = F, position = "float_left")

```



```{r}

tbl <- backteststats[[2]]
setnames(tbl, "value", "Risk Statistics")

nms <- tbl$statistic

tbl <- as.data.frame(tbl[, 2:ncol(tbl), with = FALSE])
row.names(tbl) <- nms

#rhandsontable(tbl, rowHeaderWidth = 200)

kable(tbl) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), font_size = 12, full_width = F, position = "float_left")

```


```{r}

tbl <- backteststats[[1]]
setnames(tbl, "values", "Return Statistics")

nms <- tbl$statistic

tbl <- as.data.frame(tbl[, 2:ncol(tbl), with = FALSE])
row.names(tbl) <- nms

#rhandsontable(tbl, rowHeaderWidth = 200)

kable(tbl) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), font_size = 12, full_width = F, position = "float_left")

```

## Trend System on Extended Universe of Commodities - Time Windown Report {data-background="img/BlueBackgroundWithOrange.png"}

Time Window Analysis:

```{r}

tbl <- backteststats[[6]]

nms <- tbl$variable

tbl <- as.data.frame(tbl[, 2:ncol(tbl), with = FALSE])
row.names(tbl) <- nms

#rhandsontable(tbl, rowHeaderWidth = 200)

kable(tbl) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), font_size = 12, full_width = T , position = "left")

```

Drawdown Report:

```{r}

tbl <- backteststats[[5]]

nms <- tbl$Number

tbl <- as.data.frame(tbl[, 2:ncol(tbl), with = FALSE])
row.names(tbl) <- nms

#rhandsontable(tbl, rowHeaderWidth = 200)

kable(tbl) %>%
  kable_styling(bootstrap_options = c("striped", "hover"), font_size = 12, full_width = T, position = "left")

```



